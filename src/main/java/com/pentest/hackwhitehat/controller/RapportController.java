package com.pentest.hackwhitehat.controller;

import com.pentest.hackwhitehat.entity.WpScan;
import com.pentest.hackwhitehat.service.ParseService;
import com.pentest.hackwhitehat.service.PentestService;
import org.mandas.docker.client.exceptions.DockerCertificateException;
import org.mandas.docker.client.exceptions.DockerException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.ModelAndView;

import com.pentest.hackwhitehat.entity.NmapScan;
import com.pentest.hackwhitehat.entity.Rapport;
import com.pentest.hackwhitehat.repository.RapportRepository;
import java.net.UnknownHostException;
import java.util.List;

@Controller
public class RapportController {

    private final PentestService pentestService;
    private final ParseService parseService;

    private final RapportRepository rapportRepository;

    @Autowired
    public RapportController(PentestService pentestService, ParseService parseService, RapportRepository rapportRepository) {
        this.pentestService = pentestService;
        this.parseService = parseService;
        this.rapportRepository = rapportRepository;
    }

    @RequestMapping(method = RequestMethod.POST, value = "/rapport")
    public ModelAndView home(@RequestParam("ipAddress") String ipAddress) throws DockerException, DockerCertificateException, InterruptedException, UnknownHostException {
        ModelAndView modelAndView = new ModelAndView();

         String logsNmap = pentestService.ScanIP(ipAddress);
//         String logsWpscan = pentestService.scanWpscan(ipAddress);

        NmapScan nmapScan = parseService.parseNmapOutput(logsNmap);
//           List<WpScan> wpScan = parseService.parseWpscanLogs(logsWpscan);
        List<WpScan> wpScan = parseService.parseWpscanLogs(getLogs2());

        Rapport rapport = new Rapport();
        rapport.setIpAddress(nmapScan.getIpAddress());
        rapport.setHostStatus(nmapScan.getHostStatus());
        rapport.setOpenPorts(nmapScan.getOpenPortsString());
        rapport.setTitle(wpScan.get(0).getTitle());
        rapport.setReferencelines(wpScan.get(0).getReferencelines().toString());
        this.rapportRepository.save(rapport);

        modelAndView.addObject("nmapScan", nmapScan);
        modelAndView.addObject("wpScan", wpScan);
        modelAndView.setViewName("rapport");
        return modelAndView;
    }

    public String getLogs2(){
        return "_______________________________________________________________ __ _______ _____ \\\\ \\\\ / / __ \\\\ / ____| \\\\ \\\\ /\\\\ / /| |__) | (___ ___ __ _ _ __ Â® \\\\ \\\\/ \\\\/ / | ___/ \\\\___ \\\\ / __|/ _` | '_ \\\\ \\\\ /\\\\ / | | ____) | (__| (_| | | | | \\\\/ \\\\/ |_| |_____/ \\\\___|\\\\__,_|_| |_| WordPress Security Scanner by the WPScan Team Version 3.8.22 Sponsored by Automattic - https://automattic.com/ @_WPScan_, @ethicalhack3r, @erwan_lr, @firefart _______________________________________________________________ \\u001B[32m[+]\\u001B[0m URL: https://www.voileaydat63.com/ [51.159.28.204] \\u001B[32m[+]\\u001B[0m Started: Sun May 28 10:04:16 2023 Interesting Finding(s): \\u001B[32m[+]\\u001B[0m Headers | Interesting Entries: | - server: nginx/1.17.6 | - x-redirect-by: WordPress | Found By: Headers (Passive Detection) | Confidence: 100% \\u001B[32m[+]\\u001B[0m XML-RPC seems to be enabled: https://www.voileaydat63.com/xmlrpc.php | Found By: Direct Access (Aggressive Detection) | Confidence: 100% | References: | - http://codex.wordpress.org/XML-RPC_Pingback_API | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_ghost_scanner/ | - https://www.rapid7.com/db/modules/auxiliary/dos/http/wordpress_xmlrpc_dos/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_xmlrpc_login/ | - https://www.rapid7.com/db/modules/auxiliary/scanner/http/wordpress_pingback_access/ \\u001B[32m[+]\\u001B[0m WordPress readme found: https://www.voileaydat63.com/readme.html | Found By: Direct Access (Aggressive Detection) | Confidence: 100% \\u001B[32m[+]\\u001B[0m The external WP-Cron seems to be enabled: https://www.voileaydat63.com/wp-cron.php | Found By: Direct Access (Aggressive Detection) | Confidence: 60% | References: | - https://www.iplocation.net/defend-wordpress-from-ddos | - https://github.com/wpscanteam/wpscan/issues/1299 \\u001B[32m[+]\\u001B[0m WordPress version 6.1.3 identified (Outdated, released on 0001-01-01). | Found By: Emoji Settings (Passive Detection) | - https://voileaydat63.com/6869039.html, Match: 'wp-includes\\\\/js\\\\/wp-emoji-release.min.js?ver=6.1.3' | Confirmed By: Rss Generator (Aggressive Detection) | - https://voileaydat63.com/feed/, <generator>https://wordpress.org/?v=6.1.3</generator> | - https://voileaydat63.com/comments/feed/, <generator>https://wordpress.org/?v=6.1.3</generator> \\u001B[34m[i]\\u001B[0m The main theme could not be detected. \\u001B[32m[+]\\u001B[0m Enumerating Vulnerable Plugins (via Aggressive Methods) Checking Known Locations -: |=================================================| \\u001B[32m[+]\\u001B[0m Checking Plugin Versions (via Passive and Aggressive Methods) \\u001B[34m[i]\\u001B[0m Plugin(s) Identified: \\u001B[32m[+]\\u001B[0m advanced-custom-fields-pro | Location: https://www.voileaydat63.com/wp-content/plugins/advanced-custom-fields-pro/ | Readme: https://www.voileaydat63.com/wp-content/plugins/advanced-custom-fields-pro/readme.txt | | Found By: Known Locations (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/advanced-custom-fields-pro/, status: 403 | | \\u001B[31m[!]\\u001B[0m 2 vulnerabilities identified: | | \\u001B[31m[!]\\u001B[0m Title: Advanced Custom Fields < 5.12.5 - Contributor+ PHP Object Injection | Fixed in: 5.12.5 | References: | - https://wpscan.com/vulnerability/cf376ca2-92f6-44ff-929a-ace809460a33 | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-1196 | | \\u001B[31m[!]\\u001B[0m Title: Advanced Custom Fields < 6.1.6 - Reflected XSS | Fixed in: 6.1.6 | References: | - https://wpscan.com/vulnerability/95ded80f-a47b-411e-bd17-050439bf565f | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-30777 | | Version: 5.12.4 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/advanced-custom-fields-pro/readme.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/advanced-custom-fields-pro/readme.txt \\u001B[32m[+]\\u001B[0m maintenance | Location: https://www.voileaydat63.com/wp-content/plugins/maintenance/ | Last Updated: 2023-03-26T07:59:00.000Z | Readme: https://www.voileaydat63.com/wp-content/plugins/maintenance/readme.txt | \\u001B[33m[!]\\u001B[0m The version is out of date, the latest version is 4.07 | | Found By: Known Locations (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/maintenance/, status: 403 | | \\u001B[31m[!]\\u001B[0m 1 vulnerability identified: | | \\u001B[31m[!]\\u001B[0m Title: Maintenance < 4.03 - Authenticated Stored XSS | Fixed in: 4.03 | References: | - https://wpscan.com/vulnerability/174b2119-b806-4da4-a23d-c19b552c86cb | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-24533 | | Version: 3.6.1 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/maintenance/readme.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/maintenance/readme.txt \\u001B[32m[+]\\u001B[0m photoswipe-masonry | Location: https://www.voileaydat63.com/wp-content/plugins/photoswipe-masonry/ | Last Updated: 2022-02-03T00:30:00.000Z | Readme: https://www.voileaydat63.com/wp-content/plugins/photoswipe-masonry/readme.txt | \\u001B[33m[!]\\u001B[0m The version is out of date, the latest version is 1.2.18 | | Found By: Known Locations (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/photoswipe-masonry/, status: 403 | | \\u001B[31m[!]\\u001B[0m 1 vulnerability identified: | | \\u001B[31m[!]\\u001B[0m Title: Photoswipe Masonry Gallery < 1.2.15 - Subscriber+ Stored Cross-Site Scripting | Fixed in: 1.2.15 | References: | - https://wpscan.com/vulnerability/16b80b13-3451-4b4f-99bd-451069780679 | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0750 | - https://www.wordfence.com/blog/2022/02/stored-cross-site-scripting-vulnerability-patched-in-a-wordpress-photo-gallery-plugin/ | | Version: 1.2.7 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/photoswipe-masonry/readme.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/photoswipe-masonry/readme.txt \\u001B[32m[+]\\u001B[0m wp-cloudy | Location: https://www.voileaydat63.com/wp-content/plugins/wp-cloudy/ | Latest Version: 4.4.7 (up to date) | Last Updated: 2020-12-21T18:54:00.000Z | Readme: https://www.voileaydat63.com/wp-content/plugins/wp-cloudy/readme.txt | | Found By: Known Locations (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/wp-cloudy/, status: 200 | | \\u001B[31m[!]\\u001B[0m 1 vulnerability identified: | | \\u001B[31m[!]\\u001B[0m Title: WP Cloudy < 4.4.9 - Admin+ SQL Injection | Fixed in: 4.4.9 | References: | - https://wpscan.com/vulnerability/e3b9ee9f-602d-4e9d-810c-e1e3ba604464 | - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-24864 | - https://plugins.trac.wordpress.org/changeset/2615400 | | Version: 4.4.7 (100% confidence) | Found By: Readme - Stable Tag (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/wp-cloudy/readme.txt | Confirmed By: Readme - ChangeLog Section (Aggressive Detection) | - https://www.voileaydat63.com/wp-content/plugins/wp-cloudy/readme.txt \\u001B[32m[+]\\u001B[0m WPScan DB API OK | Plan: free | Requests Done (during the scan): 8 | Requests Remaining: 9 \\u001B[32m[+]\\u001B[0m Finished: Sun May 28 10:18:54 2023 \\u001B[32m[+]\\u001B[0m Requests Done: 5699 \\u001B[32m[+]\\u001B[0m Cached Requests: 11 \\u001B[32m[+]\\u001B[0m Data Sent: 1.601 MB \\u001B[32m[+]\\u001B[0m Data Received: 2.371 MB \\u001B[32m[+]\\u001B[0m Memory used: 292.145 MB \\u001B[32m[+]\\u001B[0m Elapsed time: 00:14:37\\n\";\n";
    }
}